# 表单模板管理指南

本指南介绍如何使用 AstroPropose 的图形化界面创建和管理表单模板。

## 📋 目录

1. [访问表单管理页面](#访问表单管理页面)
2. [创建新表单模板](#创建新表单模板)
3. [编辑现有表单](#编辑现有表单)
4. [字段类型说明](#字段类型说明)
5. [最佳实践](#最佳实践)

---

## 访问表单管理页面

### 前置条件
- 使用 **Admin** 角色账户登录
- 默认管理员账户：`admin` / `password`

### 访问路径
1. 登录后，点击导航栏的 **"表单"** 链接
2. 或直接访问：`http://localhost:3000/admin/forms`

---

## 创建新表单模板

### 步骤 1：点击"新建表单"
在"创建新表单模板"区域，点击 **"+ 新建表单"** 按钮。

### 步骤 2：填写基本信息

#### 表单名称 *（必填）
- 示例：`CSST成像观测表单`、`通用科学目标表单`
- 建议：使用清晰描述性的名称

#### 适用阶段 *（必填）
- **Phase 1**：初始提案提交阶段
- **Phase 2**：详细技术配置阶段

#### 关联仪器（可选）
- **通用表单**：选择"通用表单"，所有提案都需要填写
- **仪器特定表单**：选择特定仪器（如 CSST_IM），只有使用该仪器的提案才需要填写

### 步骤 3：添加表单字段

#### 3.1 添加字段
点击 **"+ 添加字段"** 按钮，系统会创建一个新字段并自动进入编辑模式。

#### 3.2 配置字段属性

**基本属性**：
- **字段名**：程序内部使用的标识符（如 `science_goal`）
  - 只能包含字母、数字和下划线
  - 必须唯一
- **显示标签**：用户看到的字段名称（如 "科学目标"）
- **字段类型**：选择合适的输入类型（见下方说明）
- **必填字段**：勾选后，用户必须填写此字段才能提交

**可选属性**：
- **占位符文本**：输入框内的提示文字
- **行数**（仅 textarea 类型）：多行文本框的显示行数

#### 3.3 配置下拉选择字段（select 类型）
如果选择"下拉选择"类型，需要配置选项：
1. 点击 **"+ 添加选项"**
2. 输入：
   - **值**：程序内部使用（如 `high`）
   - **显示文本**：用户看到的文本（如 "高优先级"）
3. 可以添加多个选项
4. 可以删除不需要的选项

#### 3.4 调整字段顺序
- 点击 **↑** 按钮向上移动字段
- 点击 **↓** 按钮向下移动字段
- 字段显示顺序即为用户填写表单时的顺序

#### 3.5 完成编辑
点击 **"收起"** 按钮退出编辑模式，查看字段预览。

### 步骤 4：提交创建
确认所有字段配置正确后，点击 **"创建表单模板"** 按钮。

### 创建结果
- 成功后会显示绿色提示信息
- 系统自动分配版本号（如 v1）
- 表单模板立即可用

---

## 编辑现有表单

### 选择表单
在"编辑表单模板"区域的下拉菜单中选择要编辑的表单。

### 查看模板信息
灰色区域显示模板的基本信息：
- 名称
- 版本号
- 适用阶段
- 关联仪器

### 编辑字段
1. 可以添加新字段
2. 可以编辑现有字段（点击"编辑"按钮）
3. 可以删除字段（点击"删除"按钮）
4. 可以调整字段顺序

### 保存修改
点击 **"保存修改"** 按钮保存对表单的更改。

**注意**：
- 修改不会创建新版本，而是更新当前版本
- 已提交的提案不受影响（它们保存的是提交时的表单定义）

---

## 字段类型说明

### 1. 单行文本（text）
- **用途**：简短的文本输入
- **示例**：目标名称、项目编号
- **配置**：可设置占位符

### 2. 多行文本（textarea）
- **用途**：长文本输入
- **示例**：科学目标、研究背景
- **配置**：可设置行数（默认 4 行）

### 3. 数字（number）
- **用途**：数值输入
- **示例**：曝光时间、波长
- **特点**：自动验证数字格式

### 4. 下拉选择（select）
- **用途**：从预定义选项中选择
- **示例**：滤光片、优先级
- **配置**：需要添加选项列表（值+显示文本）

### 5. 复选框（checkbox）
- **用途**：是/否选择
- **示例**：时间敏感、需要快速响应
- **特点**：勾选 = true，不勾选 = false

### 6. 文件上传（file）
- **用途**：上传附件
- **示例**：观测计划文件、辅助说明文档
- **特点**：支持多种文件格式

---

## 最佳实践

### 表单设计原则

#### 1. 结构清晰
- 按逻辑分组组织字段
- 先基本信息，后详细参数
- 相关字段放在一起

#### 2. 标签明确
- 使用清晰、简洁的标签
- 避免技术术语（除非面向专业用户）
- 提供必要的说明

#### 3. 合理验证
- 关键字段设为必填
- 可选字段保持灵活
- 使用占位符提供示例

#### 4. 选项完整
- 下拉选择包含所有可能的值
- 考虑添加"其他"选项
- 保持选项列表简洁

### 通用表单 vs 仪器特定表单

#### 通用表单（Phase 1）
**建议包含**：
- 科学目标
- 提案摘要
- 项目负责人信息
- 观测时长估计

#### 仪器特定表单
**建议包含**：
- 仪器配置参数
- 观测模式
- 滤光片/波段选择
- 曝光时间
- 技术要求

### 版本管理

#### 何时创建新版本？
系统会自动处理版本：
- 相同名称+仪器+阶段的新表单 → 自动递增版本号
- 修改现有表单 → 更新当前版本

#### 版本最佳实践
- 重大变更：考虑创建新表单（不同名称）
- 小修小改：直接更新现有版本
- 测试环境：使用不同名称前缀（如 "TEST_"）

---

## 示例：创建 CSST 成像观测表单

### 场景
为 CSST 成像相机（CSST_IM）创建 Phase 1 提案表单。

### 配置
- **表单名称**：CSST成像观测表单
- **适用阶段**：Phase 1
- **关联仪器**：CSST_IM

### 字段列表

#### 1. 科学目标
- 类型：多行文本
- 标签：科学目标
- 必填：是
- 行数：6
- 占位符：请描述您的科学研究目标...

#### 2. 目标名称
- 类型：单行文本
- 标签：观测目标名称
- 必填：是
- 占位符：如：NGC 1234

#### 3. 赤经（RA）
- 类型：单行文本
- 标签：赤经 (RA)
- 必填：是
- 占位符：HH:MM:SS.ss

#### 4. 赤纬（Dec）
- 类型：单行文本
- 标签：赤纬 (Dec)
- 必填：是
- 占位符：+/-DD:MM:SS.s

#### 5. 曝光时间
- 类型：数字
- 标签：单次曝光时间（秒）
- 必填：是
- 占位符：3600

#### 6. 曝光次数
- 类型：数字
- 标签：曝光次数
- 必填：是
- 占位符：5

#### 7. 滤光片
- 类型：下拉选择
- 标签：滤光片选择
- 必填：是
- 选项：
  - u → u波段
  - g → g波段
  - r → r波段
  - i → i波段
  - z → z波段

#### 8. 优先级
- 类型：下拉选择
- 标签：观测优先级
- 必填：是
- 选项：
  - high → 高
  - medium → 中
  - low → 低

#### 9. 时间敏感
- 类型：复选框
- 标签：该观测有时间约束
- 必填：否

---

## 常见问题

### Q1: 创建表单后如何测试？
**A**: 
1. 使用 proposer 账户登录
2. 访问"创建新提案"页面
3. 选择关联此表单的提案类型
4. 选择对应的仪器
5. 查看表单是否正确显示

### Q2: 如何删除错误创建的表单？
**A**: 目前只能通过数据库操作删除。使用以下命令：
```bash
cd backend
uv run python -c "
from app import create_app, db
from app.models.models import FormTemplate
app = create_app()
with app.app_context():
    template = FormTemplate.query.get(ID)  # 替换ID
    db.session.delete(template)
    db.session.commit()
    print('已删除')
"
```

### Q3: 修改表单会影响已提交的提案吗？
**A**: 不会。已提交的提案保存的是提交时的表单定义快照，不会因为表单模板的修改而改变。

### Q4: 可以复制现有表单吗？
**A**: 目前不支持直接复制，但可以：
1. 查看现有表单的字段配置
2. 创建新表单时手动添加相同的字段
3. 或通过 API 导出/导入表单定义（高级用法）

### Q5: 表单字段顺序重要吗？
**A**: 是的。字段顺序决定了用户填写表单时的显示顺序。建议将重要的、必填的字段放在前面。

---

## 技术说明

### API 端点
- `GET /api/form-templates/` - 获取表单模板列表
- `GET /api/form-templates/:id` - 获取单个表单模板
- `POST /api/form-templates/` - 创建新表单模板（需要 Admin 权限）
- `PUT /api/form-templates/:id` - 更新表单模板（需要 Admin 权限）

### 数据格式
表单模板的 definition 字段存储 JSON 格式：
```json
{
  "fields": [
    {
      "name": "science_goal",
      "label": "科学目标",
      "type": "textarea",
      "required": true,
      "rows": 6,
      "placeholder": "请描述..."
    },
    {
      "name": "filter",
      "label": "滤光片",
      "type": "select",
      "required": true,
      "options": [
        {"value": "u", "label": "u波段"},
        {"value": "g", "label": "g波段"}
      ]
    }
  ]
}
```

---

**更新日期**: 2025-12-01  
**版本**: 1.0






